<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Unix and Linux | Blog Rudy Lee]]></title>
  <link href="http://blog.rudylee.com/categories/unix-and-linux/atom.xml" rel="self"/>
  <link href="http://blog.rudylee.com/"/>
  <updated>2016-04-17T23:12:24+10:00</updated>
  <id>http://blog.rudylee.com/</id>
  <author>
    <name><![CDATA[Rudy Lee]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[HAProxy and A/B Testing]]></title>
    <link href="http://blog.rudylee.com/2016/04/13/haproxy-and-a-slash-b-testing/"/>
    <updated>2016-04-13T15:59:00+10:00</updated>
    <id>http://blog.rudylee.com/2016/04/13/haproxy-and-a-slash-b-testing</id>
    <content type="html"><![CDATA[<p>Few weeks ago, I was given a task to create an A/B test using HAProxy. I need to make HAProxy to split traffic between two different applications ( Rails and NodeJS )</p>

<p>In this blog post, I&rsquo;ll explain how to achieve this.</p>

<h3>Create ACL for the page you want to A/B test</h3>

<p>The first step you have to do is to create an ACL for the URL you want to A/B test. In this example, the URL path is <code>/ab-test-path</code></p>

<p><code>
acl ab_test_url path_beg /ab-test-path
</code></p>

<h3>Direct the traffic based on ACL rule and cookie</h3>

<p>```</p>

<h1>Send user to first backend if they have SITEID cookie with cookie_first_backend value</h1>

<p>use_backend first-backend if { req.cook(SITEID) -m beg cookie_first_backend }</p>

<h1>Send user to second backend if they have SITEID cookie with cookie_second_backend value and the URL they request is ab_test_url</h1>

<p>use_backend second-backend if { req.cook(SITEID) -m beg cookie_second_backend } ab_test_url</p>

<h1>If the doesn&rsquo;t have any cookie send them to ab-test backend</h1>

<p>use_backend ab-test-backend if ab_test_url</p>

<h1>By default send all traffic to the first backend</h1>

<p>default_backend first-backend
```</p>

<h3>Create all the backends</h3>

<p>```
backend first-backend</p>

<pre><code>    appsession JSESSIONID len 52 timeout 3h
    cookie SERVERID insert

    balance leastconn
    server  backend02a-aws-syd 10.0.105.102:80 check maxconn 3000 inter 30s
    server  backend02b-aws-syd 10.0.106.102:80 check maxconn 3000 inter 30s
</code></pre>

<p>backend second-backend</p>

<pre><code>    server  backend03a-aws-syd 10.0.105.103:80 check maxconn 3000 inter 30s
</code></pre>

<p>backend ab-test-backend</p>

<pre><code>    balance roundrobin
    cookie SITEID insert indirect nocache maxlife 48h

    server backend02a-aws-syd 10.0.105.102:80 weight 25 cookie cookie_first_backend
    server backend02b-aws-syd 10.0.106.102:80 weight 25 cookie cookie_first_backend

    server backend03a-aws-syd 10.0.105.103:80 weight 50 cookie cookie_second_backend
</code></pre>

<p>```</p>

<p>The final HAProxy config should be something like this:</p>

<p>```
listen  http 127.0.0.1:8080</p>

<pre><code>    maxconn     18000

    # A/B Test ACLs
    acl ab_test_url path_beg /ab-test-path

    use_backend first-backend if { req.cook(SITEID) -m beg cookie_first_backend }
    use_backend second-backend if { req.cook(SITEID) -m beg cookie_second_backend } ab_test_url
    use_backend ab-test-backend if ab_test_url

    default_backend first-backend
</code></pre>

<p>backend first-backend</p>

<pre><code>    appsession JSESSIONID len 52 timeout 3h
    cookie SERVERID insert

    balance leastconn
    server  backend02a-aws-syd 10.0.105.102:80 check maxconn 3000 inter 30s
    server  backend02b-aws-syd 10.0.106.102:80 check maxconn 3000 inter 30s
</code></pre>

<p>backend second-backend</p>

<pre><code>    server  backend03a-aws-syd 10.0.105.103:80 check maxconn 3000 inter 30s
</code></pre>

<p>backend ab-test-backend</p>

<pre><code>    balance roundrobin
    cookie SITEID insert indirect nocache maxlife 48h

    server backend02a-aws-syd 10.0.105.102:80 weight 25 cookie cookie_first_backend
    server backend02b-aws-syd 10.0.106.102:80 weight 25 cookie cookie_first_backend

    server backend03a-aws-syd 10.0.105.103:80 weight 50 cookie cookie_second_backend
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Create SSH Tunnel To Backup PostgreSQL Database]]></title>
    <link href="http://blog.rudylee.com/2015/08/31/create-ssh-tunnel-to-backup-postgresql-database/"/>
    <updated>2015-08-31T10:28:00+10:00</updated>
    <id>http://blog.rudylee.com/2015/08/31/create-ssh-tunnel-to-backup-postgresql-database</id>
    <content type="html"><![CDATA[<p>Today, I was trying to create a backup of production database. The problem is we have two different version of PostgreSQL running on production and these databases can only be accessed from front end(FE) server. We have older version of PostgreSQL client installed in all FE server which means I can&rsquo;t use it to run pg_dump.</p>

<h2>SSH Tunnel to the rescue</h2>

<p>One solution to this problem is to create a SSH tunnel. Since I have the latest version of PostgreSQL client installed in my machine, I can run pg_dump locally which will connect to the database through SSH tunnel.</p>

<p>Here is the command I used to create SSH tunnel:
```bash</p>

<h1>Format: ssh -L &lt;local-port>:&lt;db-hostname>:&lt;db-port> &lt;fe-username>@&lt;fe-hostname></h1>

<p>ssh -L 9000:database.com:5432 <a href="&#109;&#x61;&#x69;&#108;&#116;&#x6f;&#x3a;&#117;&#98;&#117;&#x6e;&#x74;&#117;&#x40;&#112;&#x72;&#111;&#x64;&#117;&#99;&#116;&#x69;&#111;&#110;&#46;&#x73;&#101;&#114;&#x76;&#x65;&#x72;&#x73;&#46;&#99;&#111;&#x6d;">&#x75;&#x62;&#x75;&#x6e;&#x74;&#117;&#64;&#x70;&#x72;&#x6f;&#100;&#117;&#99;&#116;&#105;&#111;&#110;&#46;&#115;&#101;&#x72;&#118;&#101;&#x72;&#115;&#46;&#99;&#111;&#109;</a>
```</p>

<p>After this you can check whether the SSH tunnel is succesfully created by running this and look for port 9000
<code>bash
netstat -na | grep LISTEN
</code></p>

<p>If you confirm that the SSH tunnel is working, you can run psql to connect or pg_dump to backup your database
<code>bash
psql -h localhost -p 9000
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Symbolic Links With Vagrant Windows]]></title>
    <link href="http://blog.rudylee.com/2014/10/27/symbolic-links-with-vagrant-windows/"/>
    <updated>2014-10-27T14:22:00+11:00</updated>
    <id>http://blog.rudylee.com/2014/10/27/symbolic-links-with-vagrant-windows</id>
    <content type="html"><![CDATA[<p>There are few known limitations when using Vagrant on Windows machine. One of these limitations is the lack of symbolic links support on synced folder.</p>

<p>Symbolic links are used heavily by NPM to create shortcut for the libraries. I posted more details about this here: <a href="http://blog.rudylee.com/2013/10/24/fix-npm-symlink-problem-in-vagrant/">http://blog.rudylee.com/2013/10/24/fix-npm-symlink-problem-in-vagrant/</a></p>

<p>Most of the time, you can get away with &lsquo;npm &mdash;no-bin-link&rsquo; solution. However, you need more robust solution if you are using complex tools such as Grunt or Yeoman.</p>

<p>In this post, I&rsquo;ll show you the proper way to add symbolic links support to your Vagrant machine.</p>

<p>First, you need to add this code snippet inside your Vagrantfile</p>

<p>``` bash
config.vm.provider &ldquo;virtualbox&rdquo; do |v|</p>

<pre><code>v.customize ["setextradata", :id, "VBoxInternal2/SharedFoldersEnableSymlinksCreate/v-root", "1"]
</code></pre>

<p>end
```</p>

<p>VirtualBox disables symbolic links for security reasons. In order to pass this restriction, you need to boot up the Vagrant machine in Administrator mode.</p>

<p>You can do this by simply right clicking on your Command Prompt or Git Bash icon and click &lsquo;Run as Administrator&rsquo;. See the picture below if you can&rsquo;t find it.</p>

<p><a href="/images/run_as_admin.png"><img src="/images/run_as_admin.png" alt="" /></a></p>

<p>After that, boot up the Vagrant machine normally with &lsquo;vagrant up&rsquo; command. Wait until the machine boots up, SSH to the machine and try to create symbolic link in the synced folder.</p>

<h2>File path 255 character limit</h2>

<p>Another annoying problem you might encounter is file path character limit. This happens quite often if you are using a node module with long name. You can easily solve this by following these steps:</p>

<h3>Create &lsquo;node_modules&rsquo; folder in your home folder</h3>

<p><code>bash
  mkdir ~/node_modules
</code></p>

<h3>Add symbolic link to the &lsquo;node_modules&rsquo; folder you just created inside your project folder</h3>

<p><code>bash
  ln -sf ~/node_modules /vagrant/your-project-folder
</code></p>

<p>This solution will ensure that all the node modules are stored inside home directory instead of synced folder.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Enable HTTP authentication on certain domain]]></title>
    <link href="http://blog.rudylee.com/2014/09/18/enable-http-authentication-on-certain-domain/"/>
    <updated>2014-09-18T21:54:00+10:00</updated>
    <id>http://blog.rudylee.com/2014/09/18/enable-http-authentication-on-certain-domain</id>
    <content type="html"><![CDATA[<p>Basic HTTP authentication is one simple way to limit public access to your website prior to launch.</p>

<p>The first thing you need is .htaccess file which contains all the configurations. The second one is .htpasswd containing username and password. You can use this website to generate .htpasswd file for you <a href="http://www.htaccesstools.com/htpasswd-generator/">http://www.htaccesstools.com/htpasswd-generator/</a></p>

<p>In the sample below, I am trying to enable HTTP authentication only on certain domain. On the first line, I set enviroment variable if the domain name is equal to &ldquo;www.bundabergfestival.com.au&rdquo;. On line 7, I tell .htaccess file to deny any access by using the live_uri variable. I hope that explanation is pretty straight forward.</p>

<p><code>bash
SetEnvIf Host "^www.bundabergfestival.com.au" live_uri
AuthName "Bundaberg Festival Website Coming Soon"
AuthType Basic
AuthUserFile /var/app/.htpasswd
AuthGroupFile /dev/null
require valid-user
Order allow,deny
Allow from all
Deny from env=live_uri
Satisfy any
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Configuring Elastic Beanstalk Environment with .ebextensions]]></title>
    <link href="http://blog.rudylee.com/2014/05/22/configuring-elastic-beanstalk-environment-with-ebextensions/"/>
    <updated>2014-05-22T01:44:00+10:00</updated>
    <id>http://blog.rudylee.com/2014/05/22/configuring-elastic-beanstalk-environment-with-ebextensions</id>
    <content type="html"><![CDATA[<p>At <a href="http://www.captiv8.com.au">Captiv8</a>, we are using Amazon AWS to host most of our PHP projects. We are heavily rely on Elastic Beanstalk to help us set up PHP environment, database and load balancer. On top of that, we are also managing our own server image based on Amazon AMI. In this image, we installed additional software and packages that we need for our application. However, this approach has a drawback as it is difficult to maintain the image and track changes. Everytime you need to update the image, you have to create new server, install the new software and export it into new image. This will leave you with bunch of different images and it is hard to tell what are the things that have changed inside each image.</p>

<h1>Chef</h1>

<p>In order to solve these problems, I decided to find a way to automate the process. My first attempt was trying to use Chef to provision the Elastic Beanstalk environment. I have been using Chef for a while to provision my Vagrant machines. It is powerful and more convenient in compare with bash scripts. Since I am already familiar with Chef, I started looking at tutorials on how to use Chef with Elastic Beanstalk. Most of the tutorials that I found don&rsquo;t provide easy way to integrate Chef with Elastic Beanstalk. One of them mentions about using AWS OpsWorks with Chef but I think it is overkill for the time being. So, I ditched Chef and start looking for another solution.</p>

<h1>ebextensions</h1>

<p>ebextensions is another solution that I found after checking the official documentation of Elastic Beanstalk. With this solution, you need to to create .ebextensions folder inside your project and create a file to define what are the packages that you want to install into the environment. Elastic Beanstalk will automatically run the script every time you deploy a new version of the application. Aside from that, you can also tell ebextensions to execute shell script in the instance or changing permission of a file. You can read more details about ebextension here: <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html">http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html</a></p>

<p>This is my directory structure at the moment:
<a href="/images/ebextensions.png"><img src="/images/ebextensions.png" alt="" /></a></p>

<p>Here is the example of my ebextension config file:</p>

<p>``` yaml
packages:
  yum:</p>

<pre><code>mlocate: []
</code></pre>

<p>commands:
  01updateComposer:</p>

<pre><code>command: export COMPOSER_HOME=/root &amp;&amp; /usr/bin/composer.phar self-update
</code></pre>

<p>  02updateTag:</p>

<pre><code>command: ec2-create-tags $(ec2-metadata -i | cut -d ' ' -f2) --tag Project=ChangeThis
cwd: /home/ec2-user
env:
  EC2_HOME: /opt/aws/apitools/ec2
  EC2_URL: https://ec2.ap-southeast-2.amazonaws.com
  JAVA_HOME: /usr/lib/jvm/jre
  PATH: /bin:/usr/bin:/opt/aws/bin/
</code></pre>

<p>container_commands:
  01-command:</p>

<pre><code>command: updatedb
</code></pre>

<p>  02-command:</p>

<pre><code>command: rm -rf /captiv8/.ebextensions
</code></pre>

<p>  03-command:</p>

<pre><code>command: mkdir -p /captiv8/.ebextensions
</code></pre>

<p>  04-command:</p>

<pre><code>command: cp -R .ebextensions/* /captiv8/.ebextensions/
</code></pre>

<p>  05-command:</p>

<pre><code>command: bash /captiv8/.ebextensions/scripts/app-setup.sh
</code></pre>

<p>option_settings:
  &ndash; namespace: aws:elasticbeanstalk:application:environment</p>

<pre><code>option_name: COMPOSER_HOME
value: /root
</code></pre>

<p>```</p>

<p>And this is the example of my bash script:</p>

<p>``` bash</p>

<h1>!/usr/bin/env bash</h1>

<p>#</p>

<h1>References:</h1>

<h1>&ndash; <a href="http://www.hudku.com/blog/configuration-setup-customizing-aws-elastic-beanstalk/">http://www.hudku.com/blog/configuration-setup-customizing-aws-elastic-beanstalk/</a></h1>

<h1>&ndash; <a href="http://www.hudku.com/blog/security-credentials-customizing-aws/#.elastic-beanstalk-app">http://www.hudku.com/blog/security-credentials-customizing-aws/#.elastic-beanstalk-app</a></h1>

<p>#</p>

<h1>Main configuration, change these for each project</h1>

<p>appName=&ldquo;change_this&rdquo;
newrelicLicense=&ldquo;newreliclicense&rdquo;</p>

<h1>Check if this is the very first time that this script is running</h1>

<p>if ([ ! -f /root/.not-a-new-instance.txt ]) then
  newEC2Instance=true
fi</p>

<h1>Install applications if this is new instance</h1>

<p>if ([ $newEC2Instance ]) then</p>

<pre><code># Allow sudo command to be used as part of beanstalk ebextensions scripts without a terminal
grep -q 'Defaults:root !requiretty' /etc/sudoers.d/$appName || echo -e 'Defaults:root !requirettyn' &gt; /etc/sudoers.d/$appName
chmod 440 /etc/sudoers.d/$appName

# Add sudo command if not already present to .bashrc of ec2-user so that we are logged on as root when we use ssh
grep -q "sudo -s" /home/ec2-user/.bashrc || echo -e "nsudo -sn" &gt;&gt; /home/ec2-user/.bashrc
</code></pre>

<p>  # Install phpMyAdmin
  yum -y &mdash;enablerepo=epel install phpmyadmin
  rm /etc/httpd/conf.d/phpMyAdmin.conf
  rm /etc/phpMyAdmin/config.inc.php
  mv /captiv8/.ebextensions/templates/phpMyAdmin/phpMyAdmin.conf /etc/httpd/conf.d/
  mv /captiv8/.ebextensions/templates/phpMyAdmin/config.inc.php /etc/phpMyAdmin/
  chmod 644 /etc/httpd/conf.d/phpMyAdmin.conf
  chmod 644 /etc/phpMyAdmin/config.inc.php
  service httpd restart</p>

<p>  # Install New Relic
  rpm -Uvh <a href="http://yum.newrelic.com/pub/newrelic/el5/x86_64/newrelic-repo-5-3.noarch.rpm">http://yum.newrelic.com/pub/newrelic/el5/x86_64/newrelic-repo-5-3.noarch.rpm</a>
  yum -y install newrelic-php5<br/>
  echo -ne &lsquo;\n\&rsquo; | newrelic-install install
  rm /etc/php.d/newrelic.ini
  mv /captiv8/.ebextensions/templates/newrelic/newrelic.ini /etc/php.d/
  chmod 644 /etc/php.d/newrelic.ini
  perl -pi -e &ldquo;s/PHP Application/$appName/g&rdquo; /etc/php.d/newrelic.ini
  perl -pi -e &ldquo;s/newrelicLicense/$newrelicLicense/g&rdquo; /etc/php.d/newrelic.ini</p>

<p>  # Install New Relic Server Monitor<br/>
  yum -y install newrelic-sysmond
  nrsysmond-config &mdash;set license_key=$newrelicLicense
  /etc/init.d/newrelic-sysmond start
  service httpd restart</p>

<p>  # Install OSSEC
  yum -y install mysql-devel postgresql-devel
  wget <a href="http://www.ossec.net/files/ossec-hids-2.7.1.tar.gz">http://www.ossec.net/files/ossec-hids-2.7.1.tar.gz</a> -P /captiv8
  tar xzvf /captiv8/ossec-hids-2.7.1.tar.gz -C /captiv8
  rm /captiv8/ossec-hids-2.7.1.tar.gz
  rm /captiv8/ossec-hids-2.7.1/etc/preloaded-vars.conf
  mv /captiv8/.ebextensions/templates/ossec/preloaded-vars.conf /captiv8/ossec-hids-2.7.1/etc/
  /captiv8/ossec-hids-2.7.1/install.sh
  /var/ossec/bin/ossec-control start
fi</p>

<h1>If new instance, now it is not new anymore</h1>

<p>if ([ $newEC2Instance ]) then</p>

<pre><code>echo -n "" &gt; /root/.not-a-new-instance.txt
chmod 644 /etc/php.d/.not-a-new-instance
</code></pre>

<p>fi
```</p>

<p>Inside my ebextensions config file, I call the shell script which will install additional software. The benefit of using shell script is you have more options and it is much easier to customize the software. Since the .ebextensions folder is copied to the instance, you can tell the shell script to copy a template config file that you have prepared before hand. I hope you find this blog post useful.</p>
]]></content>
  </entry>
  
</feed>
